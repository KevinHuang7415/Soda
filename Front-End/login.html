<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å…¥æœƒå“¡</title>
  <!-- Reset -->
  <link rel="stylesheet" href="./css/Reset.css">
  <!-- main_setting -->
  <link rel="stylesheet" href="./css/main_setting.css">
  <!-- nav.js -->
  <script src="./js/nav.js"></script>
  <!-- style.css -->
  <link rel="stylesheet" href="./css/shoppingCart_style.css">
  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- jQuery -->
  <script src="./js/jquery-3.4.1.min.js"></script>
  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.2/TweenMax.min.js"></script>
  <!-- bubbles.js -->
  <script src="./js/bubbles.js"></script>
  <!-- Footer -->
  <script src="./js/footer.js"></script>

  <style>
    /* register CSS */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--light-yellow);
      display: flex;
      flex-direction: column;
    }

    .containerAcc {
      margin: auto;
      width: calc(300px + (300) * ((100vw - 480px) / (1200 - 480)));
      /* åœ¨ 480px å¯¬è¢å¹•æ™‚å¯¬åº¦ç´„ç‚º 300px
         åœ¨ 1200px å¯¬è¢å¹•æ™‚å¯¬åº¦ç´„ç‚º 800px
         ä¹‹é–“æœƒå¹³æ»‘è®ŠåŒ– */
      padding: 2rem 1rem;
      flex: 1;
      /* è®“å…§å®¹å€åŸŸä½”æ»¿å‰©é¤˜ç©ºé–“ */
    }


    .titleAcc {
      width: 100%
    }

    .containerAcc h1 {
      font-size: 4em;
      font-weight: bold;
      margin-bottom: 20px;
      line-height: 1.1;
    }

    .containerAcc label {
      display: block;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .containerAcc input {
      width: 92%;
      padding: 24px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .formAcc button {
      display: block;
    }




    .alc {
      text-align: center;
    }

    .mgt {
      margin-top: 40px;
    }


    @media (max-width: 768px) {
      .containerAcc h1 {
        font-size: 2em;
      }

      .containerAcc label {
        font-size: 16px;
      }

      .containerAcc input {
        font-size: 16px;
        padding: 20px;
      }
    }

    /* register CSS end */
  </style>
</head>

<body>

  <div class="containerAcc">
    <div class="titleAcc">
      <h1 class="alc mgt">ç™»å…¥æœƒå“¡</h1>
    </div>
    <form class="formAcc" id="formAcc">
      <label for="account" class="mgt">æœƒå“¡å¸³è™Ÿ/éƒµä»¶ä¿¡ç®±</label>
      <input type="text" id="account" class="account" placeholder="ä½¿ç”¨è€…å¸³è™Ÿ">

      <label for="password">å¯†ç¢¼</label>
      <input type="password" id="password" class="password" placeholder="XXXX - XXXX">
      <p class="alc"><a href="./forgotPassword.html">å¿˜è¨˜å¯†ç¢¼</a></p>

      <button type="submit" class="btn btn-l send">ç™»å…¥</button>
      <p class="alc"><a href="./register.html">è¨»å†Šæœƒå“¡</a></p>
    </form>
  </div>




  <!-- ShoppingCart (æ–°ç‰ˆ - API ç‰ˆæœ¬) -->
  <script src="./js/shoppingCart_v2.js"></script>


  <script>

    const account = document.querySelector('.account');
    const password = document.querySelector('.password');
    const formAcc = document.getElementById('formAcc');

    // é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•ä¿å­˜ä¾†æºé é¢ï¼ˆå¦‚æœé‚„æ²’æœ‰è¨­ç½® redirectAfterLoginï¼‰
    (function saveReferrerForRedirect() {
      // å¦‚æœå·²ç¶“æœ‰ redirectAfterLoginï¼ˆç”±å…¶ä»–é é¢è¨­ç½®ï¼‰ï¼Œå‰‡ä¸è¦†è“‹
      if (localStorage.getItem('redirectAfterLogin')) {
        console.log('å·²æœ‰ redirectAfterLoginï¼Œä¿æŒåŸè¨­å®š');
        return;
      }

      // ç²å–ä¾†æºé é¢
      const referrer = document.referrer;
      if (!referrer) {
        console.log('ç„¡ä¾†æºé é¢ï¼Œè·³éè¨­ç½® redirectAfterLogin');
        return;
      }

      try {
        // è§£æä¾†æº URL
        const referrerUrl = new URL(referrer);
        const currentUrl = new URL(window.location.href);
        
        // ç¢ºä¿ä¾†æºé é¢æ˜¯åŒä¸€å€‹ç¶²ç«™ï¼ˆåŒåŸŸåï¼‰
        if (referrerUrl.origin !== currentUrl.origin) {
          console.log('ä¾†æºé é¢ç‚ºå¤–éƒ¨ç¶²ç«™ï¼Œè·³éè¨­ç½®');
          return;
        }

        // å¦‚æœä¾†æºé é¢å°±æ˜¯ç™»å…¥é é¢æœ¬èº«ï¼Œå‰‡ä¸è¨­ç½®
        const referrerPath = referrerUrl.pathname;
        if (referrerPath.includes('login.html')) {
          console.log('ä¾†æºé é¢ç‚ºç™»å…¥é é¢æœ¬èº«ï¼Œè·³éè¨­ç½®');
          return;
        }

        // æ§‹å»ºè¿”å› URLï¼ˆåŒ…å«å®Œæ•´è·¯å¾‘å’ŒæŸ¥è©¢åƒæ•¸ï¼‰
        const returnUrl = referrerPath + referrerUrl.search;
        
        // è½‰æ›ç‚ºç›¸å°è·¯å¾‘ï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
        // ä¾‹å¦‚ï¼š/Front-End/product.html?param=value -> ./product.html?param=value
        let relativePath = returnUrl;
        if (relativePath.startsWith('/')) {
          // æ‰¾åˆ°æœ€å¾Œä¸€å€‹æ–œç·šå¾Œçš„æ–‡ä»¶å
          const fileName = relativePath.split('/').pop();
          relativePath = './' + fileName;
        } else if (!relativePath.startsWith('./')) {
          relativePath = './' + relativePath;
        }

        // ä¿å­˜ç‚º redirectAfterLogin
        localStorage.setItem('redirectAfterLogin', relativePath);
        console.log('âœ… å·²è‡ªå‹•ä¿å­˜ä¾†æºé é¢:', relativePath);
      } catch (error) {
        console.error('è§£æä¾†æºé é¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    })();

    // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
    formAcc.addEventListener('submit', function (e) {
      e.preventDefault(); // é˜»æ­¢è¡¨å–®é»˜èªæäº¤è¡Œç‚º
      callSignIn();
    });

    function callSignIn() {
      // é©—è­‰è¼¸å…¥
      if (account.value === "" || password.value === "") {
        alert("è«‹å¡«å¯«æ­£ç¢ºè³‡è¨Š");
        return;
      }
      const obj = {
        usernameOrEmail: account.value,
        password: password.value
      };
      console.log('ç™¼é€è³‡æ–™:', obj);
      axios.post('https://localhost:7085/api/Auth/login', obj)
        .then(function (response) {
          console.log('ç™»å…¥æˆåŠŸå›æ‡‰:', response.data);

          if (response.data.success) {
            const token = response.data.token;
            const user = response.data.user;
            
            // å„²å­˜ token åˆ° localStorageï¼ˆä¾› nav.js çš„ isLoggedIn() ä½¿ç”¨ï¼‰
            localStorage.setItem('token', token);
            
            // â­ å„²å­˜å®Œæ•´çš„ç”¨æˆ¶è³‡è¨Šï¼ˆåŒ…å« firstName, lastName, address, phoneNumber ç­‰ï¼‰
            const userData = {
              ...user,  // åŒ…å«æ‰€æœ‰å¾Œç«¯è¿”å›çš„æ¬„ä½
              token: token  // é¡å¤–æ·»åŠ  token
            };
            localStorage.setItem('user', JSON.stringify(userData));

            alert(`${user.username} æ­å–œç™»å…¥æˆåŠŸï¼`);

            // ========== æ™ºèƒ½å°å‘é‚è¼¯ ==========
            const userRole = user.role || 'User';
            let redirectUrl = localStorage.getItem('redirectAfterLogin');

            // å¦‚æœæ²’æœ‰ä¿å­˜çš„ redirectAfterLoginï¼Œå˜—è©¦å¾ URL åƒæ•¸ç²å–
            if (!redirectUrl) {
              const urlParams = new URLSearchParams(window.location.search);
              redirectUrl = urlParams.get('returnUrl');
              if (redirectUrl) {
                localStorage.setItem('redirectAfterLogin', redirectUrl);
              }
            }

            // å„ªå…ˆè™•ç†è¿”å›åŸé é¢çš„éœ€æ±‚
            if (redirectUrl) {
              localStorage.removeItem('redirectAfterLogin');
              console.log('ğŸ”™ å°å‘å›ä¸Šä¸€å€‹é é¢:', redirectUrl);
              
              // æ›´æ–°å°èˆªæ¬„ç‹€æ…‹ï¼ˆå¦‚æœå‡½æ•¸å­˜åœ¨ï¼‰
              if (typeof window.updateNavLoginStatus === 'function') {
                window.updateNavLoginStatus();
              }
              
              // å»¶é²ä¸€å°æ®µæ™‚é–“ï¼Œè®“å°èˆªæ¬„æœ‰æ™‚é–“æ›´æ–°
              setTimeout(() => {
                window.location.href = redirectUrl;
              }, 100);
            } else if (userRole === 'Admin') {
              // å¦‚æœæ˜¯ç®¡ç†å“¡ä¸”æ²’æœ‰è¦è¿”å›çš„é é¢ï¼Œæ‰è©¢å•æ˜¯å¦å‰å¾€å¾Œå°
              if (typeof window.updateNavLoginStatus === 'function') {
                window.updateNavLoginStatus();
              }
              if (confirm('ç¾åœ¨å°‡å¼•å°æ‚¨å‰å¾€ç®¡ç†è€…ç•«é¢')) {
                window.open('./Dashboard.html', '_blank'); // æ–°è¦–çª—é–‹å•Ÿå¾Œå°
                window.location.href = './index.html'; // å°å‘é¦–é 
              } else {
                window.location.href = './index.html';
              }
            } else {
              // ä¸€èˆ¬ç”¨æˆ¶ä¸”æ²’æœ‰è¦è¿”å›çš„é é¢ï¼Œå°å‘é¦–é æˆ–æœƒå“¡ä¸­å¿ƒ
              if (typeof window.updateNavLoginStatus === 'function') {
                window.updateNavLoginStatus();
              }
              // å°å‘é¦–é ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒç€è¦½
              window.location.href = './index.html';
            }
            // ==================================
          } else {
            alert(response.data.message || "ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
          }
        })
        .catch(function (error) {
          console.error('ç™»å…¥éŒ¯èª¤:', error);

          if (error.response) {
            alert(error.response.data.message || "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
          } else if (error.request) {
            alert("ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦å•Ÿå‹•");
          } else {
            alert("ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
          }
        });
    }

    // åˆå§‹åŒ–æ³¡æ³¡å‹•ç•«
    initBubbles({
      maxBubbles: 15  // è¼ƒå°‘çš„æ³¡æ³¡æ•¸é‡ï¼Œé¿å…å¹²æ“¾ç™»å…¥è¡¨å–®
    });
  
  </script>
</body>

</html>