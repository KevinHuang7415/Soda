<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登入會員</title>
  <!-- Reset -->
  <link rel="stylesheet" href="./css/Reset.css">
  <!-- main_setting -->
  <link rel="stylesheet" href="./css/main_setting.css">
  <!-- nav.js -->
  <script src="./js/nav.js"></script>
  <!-- style.css -->
  <link rel="stylesheet" href="./css/shoppingCart_style.css">
  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- jQuery -->
  <script src="./js/jquery-3.4.1.min.js"></script>

  <style>
    /* register CSS */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--light-yellow);
      display: flex;
      flex-direction: column;
    }

    .containerAcc {
      margin: auto;
      width: calc(300px + (300) * ((100vw - 480px) / (1200 - 480)));
      /* 在 480px 寬螢幕時寬度約為 300px
         在 1200px 寬螢幕時寬度約為 800px
         之間會平滑變化 */
      padding: 2rem 1rem;
      flex: 1; /* 讓內容區域佔滿剩餘空間 */
    }
    
    /* Footer 貼底樣式 */
    #site-footer {
      margin-top: auto; /* 將 footer 推到底部 */
    }

    .titleAcc {
      width: 100%
    }

    .containerAcc h1 {
      font-size: 4em;
      font-weight: bold;
      margin-bottom: 20px;
      line-height: 1.1;
    }

    .containerAcc label {
      display: block;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .containerAcc input {
      width: 92%;
      padding: 24px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .formAcc button {
      display: block;
    }

    @font-face {
      font-family: "FakePearl-regular";
      /* 自訂名稱 */
      src: url("./fonts/FakePearl-regular.ttf") format("truetype");
      /* 字體檔路徑 */
      font-weight: normal;
      font-style: normal;
    }

    /* 套用字體 */
    body {
      font-family: "FakePearl-regular", sans-serif;
    }

    .alc {
      text-align: center;
    }

    .mgt {
      margin-top: 40px;
    }

    @media (max-width: 768px) {
      .containerAcc h1 {
        font-size: 2em;
      }

      .containerAcc label {
        font-size: 16px;
      }

      .containerAcc input {
        font-size: 16px;
        padding: 20px;
      }
    }

    /* register CSS end */
  </style>
</head>

<body>
  
  <div class="containerAcc">
    <div class="titleAcc">
      <h1 class="alc mgt">登入會員</h1>
    </div>
    <form class="formAcc" id="formAcc">
      <label for="account" class="mgt">會員帳號/郵件信箱</label>
      <input type="text" id="account" class="account" placeholder="使用者帳號">

      <label for="password">密碼</label>
      <input type="password" id="password" class="password" placeholder="XXXX - XXXX">
      <p class="alc"><a href="./forgotPassword.html">忘記密碼</a></p>

      <button type="submit" class="btn btn-l send">登入</button>
      <p class="alc"><a href="./register.html">註冊會員</a></p>
    </form>
  </div>

  <!-- Footer -->
  <div id="site-footer"></div>

  <!-- ShoppingCart (新版 - API 版本) -->
  <script src="./js/shoppingCart_v2.js"></script>
  <!-- Include script -->
  <script src="./js/include.js"></script>

  <script>

    const account = document.querySelector('.account');
    const password = document.querySelector('.password');
    const formAcc = document.getElementById('formAcc');

    // 監聽表單提交事件
    formAcc.addEventListener('submit', function (e) {
      e.preventDefault(); // 阻止表單默認提交行為
      callSignIn();
    });

    function callSignIn() {
      // 驗證輸入
      if (account.value === "" || password.value === "") {
        alert("請填寫正確資訊");
        return;
      }
      const obj = {
        usernameOrEmail: account.value,  
        password: password.value
      };
      console.log('發送資料:', obj);
      axios.post('https://localhost:7085/api/Auth/login', obj)
        .then(function (response) {
          console.log('登入成功回應:', response.data);

          if (response.data.success) {
            const token = response.data.token;
            const user = response.data.user;
            localStorage.setItem('user', JSON.stringify({
              id: user.id,
              username: user.username,
              email: user.email,
              role: user.role,
              token: token
            }));

            alert(`${user.username} 恭喜登入成功！`);

            // ========== 智能導向邏輯 ==========
            const userRole = user.role || 'User';
            const redirectUrl = localStorage.getItem('redirectAfterLogin');

            if (userRole === 'Admin') {
              if (confirm('現在將引導您前往管理者畫面')) {
                window.open('./Dashboard.html', '_blank'); // 新視窗開啟後台
                window.location.href = './index.html'; // 導向首頁
              } else {
                window.location.href = './index.html';
              }
            } else if (redirectUrl) {
              localStorage.removeItem('redirectAfterLogin');
              window.location.href = redirectUrl;
            } else {
              window.location.href = './UpdateUser.html';
            }
            // ==================================
          } else {
            alert(response.data.message || "登入失敗，請重試");
          }
        })
        .catch(function (error) {
          console.error('登入錯誤:', error);

          if (error.response) {
            alert(error.response.data.message || "帳號或密碼錯誤，請重新輸入");
          } else if (error.request) {
            alert("無法連接到伺服器，請檢查網路連線或確認後端服務是否啟動");
          } else {
            alert("登入時發生錯誤：" + error.message);
          }
        });
    }
    
  </script>
</body>

</html>