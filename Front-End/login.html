<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登入會員</title>
  <!-- Reset -->
  <link rel="stylesheet" href="./css/Reset.css">
  <!-- main_setting -->
  <link rel="stylesheet" href="./css/main_setting.css">
  <!-- style.css -->
  <link rel="stylesheet" href="./css/shoppingCart_style.css">
  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* register CSS */
    body {
      background: var(--light-yellow);
    }

    .containerAcc {
      margin: auto;
      width: calc(300px + (300) * ((100vw - 480px) / (1200 - 480)));
      /* 在 480px 寬螢幕時寬度約為 300px
         在 1200px 寬螢幕時寬度約為 800px
         之間會平滑變化 */
    }

    .titleAcc {
      width: 100%
    }

    .containerAcc h1 {
      font-size: 4em;
      font-weight: bold;
      margin-bottom: 20px;
      line-height: 1.1;
    }

    .containerAcc label {
      display: block;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .containerAcc input {
      width: 92%;
      padding: 24px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .formAcc button {
      display: block;
    }

    @font-face {
      font-family: "FakePearl-regular";
      /* 自訂名稱 */
      src: url("./fonts/FakePearl-regular.ttf") format("truetype");
      /* 字體檔路徑 */
      font-weight: normal;
      font-style: normal;
    }

    /* 套用字體 */
    body {
      font-family: "FakePearl-regular", sans-serif;
    }

    .alc {
      text-align: center;
    }

    .mgt {
      margin-top: 40px;
    }

    @media (max-width: 768px) {
      .containerAcc h1 {
        font-size: 2em;
      }

      .containerAcc label {
        font-size: 16px;
      }

      .containerAcc input {
        font-size: 16px;
        padding: 20px;
      }
    }

    /* register CSS end */
  </style>
</head>

<body>
  <div class="containerAcc">
    <div class="titleAcc">
      <h1 class="alc mgt">登入會員</h1>
    </div>
    <form class="formAcc" id="formAcc">
      <label for="account" class="mgt">會員帳號/郵件信箱</label>
      <input type="text" id="account" class="account" placeholder="使用者帳號">

      <label for="password">密碼</label>
      <input type="password" id="password" class="password" placeholder="XXXX - XXXX">
      <p class="alc"><a href="./forgotPassword.html">忘記密碼</a></p>

      <button type="submit" class="btn btn-l send">登入</button>
      <p class="alc"><a href="./register.html">註冊會員</a></p>
    </form>
  </div>


  <script>
    const account = document.querySelector('.account');
    const password = document.querySelector('.password');
    const formAcc = document.getElementById('formAcc');

    // 監聽表單提交事件
    formAcc.addEventListener('submit', function (e) {
      e.preventDefault(); // 阻止表單默認提交行為
      callSingIn();
    })

    function callSingIn() {
      // 驗證輸入
      if (account.value == "" || password.value == "") {
        alert("請填寫正確資訊");
        return;
      }

      // 準備資料（欄位名稱要與後端 API 一致）
      let obj = {
        usernameOrEmail: account.value,  // 使用後端期望的欄位名稱
        password: password.value
      };
      console.log('發送資料:', obj);

      // 發送登入請求
      axios.post('https://localhost:7085/api/Auth/login', obj)
        .then(function (response) {
          console.log('登入成功回應:', response.data);
          
          if (response.data.success) {
            // 儲存 token 和使用者資訊
            if (response.data.token) {
              localStorage.setItem('token', response.data.token);
            }
            if (response.data.user) {
              localStorage.setItem('user', JSON.stringify(response.data.user));
            }
            
            // 取得使用者名稱
            const userName = response.data.user?.username || response.data.user?.email || '使用者';
            
            // 顯示登入成功訊息（帶使用者名稱）
            alert(`${userName} 恭喜登入成功！`);
            
            // ========== 智能導向邏輯 ==========
            // 1. 取得使用者角色
            const userRole = response.data.user?.role || 'User';
            
            // 2. 取得來源頁面（如果有記錄的話）
            const redirectUrl = localStorage.getItem('redirectAfterLogin');
            
            // 3. 根據角色和來源決定導向
            if (userRole === 'Admin') {
              // 管理員額外提示並在新視窗開啟後台
              if (confirm('現在將引導您前往管理者畫面')) {
                // 在新視窗開啟 Dashboard
                window.open('./Dashboard.html', '_blank');
                // 當前頁面導向首頁
                window.location.href = './indexPart234.html';
              } else {
                // 使用者取消，只導向首頁
                window.location.href = './indexPart234.html';
              }
            } else if (redirectUrl) {
              // 如果有記錄來源頁面，導回該頁面
              localStorage.removeItem('redirectAfterLogin'); // 清除記錄
              window.location.href = redirectUrl;
            } else {
              // 預設導向首頁
              window.location.href = './indexPart234.html';
            }
            // ==================================
          } else {
            alert(response.data.message || "登入失敗，請重試");
          }
        })
        .catch(function (error) {
          console.error('登入錯誤:', error);
          
          if (error.response) {
            // 伺服器回應錯誤
            alert(error.response.data.message || "帳號或密碼錯誤，請重新輸入");
          } else if (error.request) {
            // 請求發送但沒有收到回應
            alert("無法連接到伺服器，請檢查網路連線或確認後端服務是否啟動");
          } else {
            // 其他錯誤
            alert("登入時發生錯誤：" + error.message);
          }
        });
    }

  </script>
</body>

</html>