<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>更新個人資料</title>
  <!-- Reset -->
  <link rel="stylesheet" href="./css/Reset.css">
  <!-- main_setting -->
  <link rel="stylesheet" href="./css/main_setting.css">
  <!-- style.css -->
  <link rel="stylesheet" href="./css/shoppingCar.css">
  <!-- axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- jQuery for include functionality -->
  <script src="./js/jquery-3.4.1.min.js"></script>

  <style>
    /* Footer 置底樣式 */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    /* 確保 nav 正確顯示 */
    #site-header {
      position: relative;
      z-index: 1000;
      width: 100%;
    }
    
    /* 確保 navbar 內容不被截斷 */
    #site-header .navbar {
      position: relative !important;
      width: 100% !important;
    }
    /* register CSS */
    body {
      background: var(--light-yellow);
      display: flex;
      flex-direction: column;
    }

    .containerAcc {
      margin: auto;
      width: calc(300px + (300) * ((100vw - 480px) / (1200 - 480)));
      /* 在 480px 寬螢幕時寬度約為 300px
         在 1200px 寬螢幕時寬度約為 800px
         之間會平滑變化 */
      flex: 1;
      padding: 2rem 1rem;
    }
    
    /* Footer 置底樣式 */
    #site-footer {
      margin-top: auto; /* 將 footer 推到底部 */
    }

    .titleAcc {
      width: 100%
    }

    .containerAcc h1 {
      font-size: 4em;
      font-weight: bold;
      margin-bottom: 20px;
      line-height: 1.1;
    }

    .containerAcc label {
      display: block;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .containerAcc input {
      width: 92%;
      padding: 24px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .formAcc button {
      display: block;
    }

    .alc {
      text-align: center;
    }

    .mgt {
      margin-top: 40px;
    }

    @font-face {
      font-family: "FakePearl-regular";
      /* 自訂名稱 */
      src: url("./fonts/FakePearl-regular.ttf") format("truetype");
      /* 字體檔路徑 */
      font-weight: normal;
      font-style: normal;
    }

    /* 套用字體 */
    body {
      font-family: "FakePearl-regular", sans-serif;
    }

    @media (max-width: 768px) {
      .containerAcc h1 {
        font-size: 2em;
      }

      .containerAcc label {
        font-size: 16px;
      }

      .containerAcc input {
        font-size: 16px;
        padding: 20px;
      }

    }

    /* register CSS end */
  </style>
</head>

<body>
  <!-- Navigation -->
  <div id="site-header"></div>
  
  <div class="containerAcc">
    <div class="titleAcc">
      <h1 class="alc mgt">更新個人資料</h1>
    </div>
    <div id="messageContainer" style="color:red; text-align:center; margin-bottom:10px;"></div>
    <form class="formAcc" id="formAcc">
      <label for="UserName">使用者名稱</label>
      <input type="text" id="UserName" placeholder="test">

      <label for="FirstName">姓氏</label>
      <input type="text" id="FirstName" placeholder="王">

      <label for="LastName">名字</label>
      <input type="text" id="LastName" placeholder="小明">

      <label for="Address">Address</label>
      <input type="text" id="Address" placeholder="XXXX - XXXX">

      <button type="button" class="btn btn-l alc" onclick="UpdateInfo()">更新</button>
    </form>
  </div>

  <!-- Footer -->
  <div id="site-footer"></div>

  <!-- Include script -->
  <script src="./js/include.js"></script>
</body>
<script>

  function showMessage(message, type = 'error') {
    const container = document.getElementById('messageContainer');
    container.textContent = message;
    container.style.color = type === 'error' ? 'red' : 'green';
    setTimeout(() => {
      container.textContent = '';
    }, 3000);
  }


  const userData = localStorage.getItem('user');

  if (!userData) {
    alert("尚未登入，請先登入");
    window.location.href = "./login.html";
  } else {
    const user = JSON.parse(userData);
    const userId = user.id;
    const token = user.token; 

    console.log("目前登入的使用者 ID:", userId);
    console.log("目前登入的 token:", token);

    if (!token) {
      alert("登入逾時，請重新登入");
      localStorage.removeItem('user');
      window.location.href = "./login.html";
    } else {
      loadUserData(userId, token);
    }
  }

  function loadUserData(id, token) {
    axios.get(`https://localhost:7085/api/User/${id}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => {
        const data = res.data;
        console.log("取得的使用者資料:", data);

        document.getElementById('UserName').value = data.username;
        document.getElementById('FirstName').value = data.firstName;
        document.getElementById('LastName').value = data.lastName;
        document.getElementById('Address').value = data.address;
      })
      .catch(err => {
        console.error("載入失敗:", err.response || err);
        if (err.response && err.response.status === 401) {
          alert("登入驗證已過期，請重新登入");
          localStorage.removeItem('user');
          window.location.href = "./login.html";
        } else {
          alert("無法載入使用者資料");
        }
      });
  }
  function UpdateInfo() {
    const user = JSON.parse(localStorage.getItem('user'));
    const userId = user.id;
    const token = user.token;

    const UserName = document.getElementById('UserName').value.trim();
    const FirstName = document.getElementById('FirstName').value.trim();
    const LastName = document.getElementById('LastName').value.trim();
    const Address = document.getElementById('Address').value.trim();

    if (!UserName || !FirstName || !LastName || !Address) {
      alert('請輸入完整內容');
      return;
    }
    const payload = {
      Username: UserName,
      FirstName: FirstName,
      LastName: LastName,
      Address: Address
    };

    console.log("送到 API 的資料:", payload);

    axios.put(`https://localhost:7085/api/UpdateUserInfo/${userId}`, payload, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
      .then(res => {
        alert(res.data.message || "更新成功！");
      })
      .catch(err => {
        console.error("更新錯誤:", err.response || err);
        if (err.response && err.response.status === 401) {
          alert("登入驗證已過期，請重新登入");
          localStorage.removeItem('user');
          window.location.href = "./login.html";
        } else {
          alert(err.response?.data?.message || '更新失敗');
        }
      });
  }
</script>

</html>